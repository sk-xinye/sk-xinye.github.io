<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sk-xinye.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.yml"};
  </script>

  <meta name="description" content="愿所有努力都不被辜负">
<meta property="og:type" content="website">
<meta property="og:title" content="sk-xinyeの博客">
<meta property="og:url" content="https://sk-xinye.github.io/default-index/page/2/index.html">
<meta property="og:site_name" content="sk-xinyeの博客">
<meta property="og:description" content="愿所有努力都不被辜负">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="sk-xinye">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://sk-xinye.github.io/default-index/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>sk-xinyeの博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">sk-xinyeの博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录学习的脚步</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-fa fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">0</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">0</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">142</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2023/02/04/3.%20mmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/04/3.%20mmap/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-02-04 10:34:09 / 修改时间：10:33:07" itemprop="dateCreated datePublished" datetime="2023-02-04T10:34:09+08:00">2023-02-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MMAP"><a href="#MMAP" class="headerlink" title="MMAP"></a>MMAP</h1><h2 id="1-mmap-基础概念"><a href="#1-mmap-基础概念" class="headerlink" title="1. mmap 基础概念"></a>1. mmap 基础概念</h2><p>mmap 即 memory map，也就是内存映射。</p>
<p>mmap 是一种内存映射文件的方法，即<strong>将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系</strong>。实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作而不必再调用 read、write 等系统调用函数。相反，内核空间对这段区域的修改也直接反映用户空间，从而可以实现不同进程间的文件共享。如下图所示：</p>
<p><img src="./images/200501092691998.png" alt="img"></p>
<p>mmap 具有如下的特点：</p>
<ol>
<li>mmap 向应用程序提供的内存访问接口是内存地址连续的，但是对应的磁盘文件的 block 可以不是地址连续的；</li>
<li>mmap 提供的内存空间是虚拟空间（虚拟内存），而不是物理空间（物理内存），因此完全可以分配远远大于物理内存大小的虚拟空间（例如 16G 内存主机分配 1000G 的 mmap 内存空间）；</li>
<li>mmap 负责映射文件逻辑上一段连续的数据（物理上可以不连续存储）映射为连续内存，而这里的文件可以是磁盘文件、驱动假造出的文件（例如 DMA 技术）以及设备；</li>
<li>mmap 由操作系统负责管理，对同一个文件地址的映射将被所有线程共享，操作系统确保线程安全以及线程可见性；</li>
</ol>
<p>mmap 的设计很有启发性。基于磁盘的读写单位是 block（一般大小为 4KB），而基于内存的读写单位是地址（虽然内存的管理与分配单位是 4KB）。换言之，CPU 进行一次磁盘读写操作涉及的数据量至少是 4KB，但是进行一次内存操作涉及的数据量是基于地址的，也就是通常的 64bit（64 位操作系统）。mmap  下进程可以采用指针的方式进行读写操作，这是值得注意的。</p>
<h2 id="2-mmap-的-I-O-模型"><a href="#2-mmap-的-I-O-模型" class="headerlink" title="2. mmap 的 I/O 模型"></a>2. mmap 的 I/O 模型</h2><p>mmap 也是一种零拷贝技术，其 I/O 模型如下图所示：</p>
<p><img src="images/mmap.jpg" alt="mmap"></p>
<p>mmap 技术有如下特点：</p>
<ol>
<li>利用 DMA 技术来取代 CPU 来在内存与其他组件之间的数据拷贝，例如从磁盘到内存，从内存到网卡；</li>
<li>用户空间的 mmap file 使用虚拟内存，实际上并不占据物理内存，只有在内核空间的 kernel buffer cache 才占据实际的物理内存；</li>
<li><code>mmap()</code> 函数需要配合 <code>write()</code> 系统调动进行配合操作，这与 <code>sendfile()</code> 函数有所不同，后者一次性代替了 <code>read()</code> 以及 <code>write()</code>；因此 mmap 也至少需要 4 次上下文切换；</li>
<li>mmap 仅仅能够避免内核空间到用户空间的全程 CPU 负责的数据拷贝，但是内核空间内部还是需要全程 CPU 负责的数据拷贝；</li>
</ol>
<p>利用 <code>mmap()</code> 替换 <code>read()</code>，配合 <code>write()</code> 调用的整个流程如下：</p>
<ol>
<li>用户进程调用 <code>mmap()</code>，从用户态陷入内核态，将内核缓冲区映射到用户缓存区；</li>
<li>DMA 控制器将数据从硬盘拷贝到内核缓冲区（可见其使用了 Page Cache 机制）；</li>
<li><code>mmap()</code> 返回，上下文从内核态切换回用户态；</li>
<li>用户进程调用 <code>write()</code>，尝试把文件数据写到内核里的套接字缓冲区，再次陷入内核态；</li>
<li>CPU 将内核缓冲区中的数据拷贝到的套接字缓冲区；</li>
<li>DMA 控制器将数据从套接字缓冲区拷贝到网卡完成数据传输；</li>
<li><code>write()</code> 返回，上下文从内核态切换回用户态。</li>
</ol>
<h2 id="3-mmap-的优势"><a href="#3-mmap-的优势" class="headerlink" title="3. mmap 的优势"></a>3. mmap 的优势</h2><p><strong>1.简化用户进程编程</strong></p>
<p>在用户空间看来，通过 mmap 机制以后，磁盘上的文件仿佛直接就在内存中，把访问磁盘文件简化为按地址访问内存。这样一来，应用程序自然不需要使用文件系统的 write（写入）、read（读取）、fsync（同步）等系统调用，因为现在只要面向内存的虚拟空间进行开发。</p>
<p>但是，这并不意味着我们不再需要进行这些系统调用，而是说这些系统调用由操作系统在 mmap 机制的内部封装好了。</p>
<p><strong>（1）基于缺页异常的懒加载</strong></p>
<p>出于节约物理内存以及 mmap 方法快速返回的目的，mmap 映射采用懒加载机制。具体来说，通过 mmap 申请 1000G 内存可能仅仅占用了 100MB 的虚拟内存空间，甚至没有分配实际的物理内存空间。当你访问相关内存地址时，才会进行真正的 write、read 等系统调用。CPU 会通过陷入缺页异常的方式来将磁盘上的数据加载到物理内存中，此时才会发生真正的物理内存分配。</p>
<p><strong>（2）数据一致性由 OS 确保</strong></p>
<p>当发生数据修改时，内存出现脏页，与磁盘文件出现不一致。mmap 机制下由操作系统自动完成内存数据落盘（脏页回刷），用户进程通常并不需要手动管理数据落盘。</p>
<p><strong>2.读写效率提高：避免内核空间到用户空间的数据拷贝</strong></p>
<p>简而言之，mmap 被认为快的原因是因为建立了页到用户进程的虚地址空间映射，以读取文件为例，避免了页从内核空间拷贝到用户空间。</p>
<p><strong>3.避免只读操作时的 swap 操作</strong></p>
<p>虚拟内存带来了种种好处，但是一个最大的问题在于所有进程的虚拟内存大小总和可能大于物理内存总大小，因此当操作系统物理内存不够用时，就会把一部分内存 swap 到磁盘上。</p>
<p>在 mmap 下，如果虚拟空间没有发生写操作，那么由于通过 mmap 操作得到的内存数据完全可以通过再次调用 mmap 操作映射文件得到。但是，通过其他方式分配的内存，在没有发生写操作的情况下，操作系统并不知道如何简单地从现有文件中（除非其重新执行一遍应用程序，但是代价很大）恢复内存数据，因此必须将内存 swap 到磁盘上。</p>
<p><strong>4.节约内存</strong></p>
<p>由于用户空间与内核空间实际上共用同一份数据，因此在大文件场景下在实际物理内存占用上有优势。</p>
<h2 id="4-mmap-不是银弹"><a href="#4-mmap-不是银弹" class="headerlink" title="4. mmap 不是银弹"></a>4. mmap 不是银弹</h2><p>mmap 不是银弹，这意味着 mmap 也有其缺陷，在相关场景下的性能存在缺陷：</p>
<ol>
<li>由于 mmap 使用时必须实现指定好内存映射的大小，因此 mmap 并不适合变长文件；</li>
<li>如果更新文件的操作很多，mmap 避免两态拷贝的优势就被摊还，最终还是落在了大量的脏页回写及由此引发的随机 I/O 上，所以在随机写很多的情况下，mmap 方式在效率上不一定会比带缓冲区的一般写快；</li>
<li>读/写小文件（例如 16K 以下的文件），mmap 与通过 read 系统调用相比有着更高的开销与延迟；同时 mmap 的刷盘由系统全权控制，但是在小数据量的情况下由应用本身手动控制更好；</li>
<li>mmap 受限于操作系统内存大小：例如在 32-bits 的操作系统上，虚拟内存总大小也就 2GB，但由于 mmap 必须要在内存中找到一块连续的地址块，此时你就无法对 4GB 大小的文件完全进行 mmap，在这种情况下你必须分多块分别进行 mmap，但是此时地址内存地址已经不再连续，使用 mmap 的意义大打折扣，而且引入了额外的复杂性；</li>
</ol>
<h2 id="5-mmap-的适用场景"><a href="#5-mmap-的适用场景" class="headerlink" title="5. mmap 的适用场景"></a>5. mmap 的适用场景</h2><p>mmap 的适用场景实际上非常受限，在如下场合下可以选择使用 mmap 机制：</p>
<ol>
<li>多个线程以只读的方式同时访问一个文件，这是因为 mmap 机制下多线程共享了同一物理内存空间，因此节约了内存。案例：多个进程可能依赖于同一个动态链接库，利用 mmap 可以实现内存仅仅加载一份动态链接库，多个进程共享此动态链接库。</li>
<li>mmap 非常适合用于进程间通信，这是因为对同一文件对应的 mmap 分配的物理内存天然多线程共享，并可以依赖于操作系统的同步原语；</li>
<li>mmap 虽然比 sendfile 等机制多了一次 CPU 全程参与的内存拷贝，但是用户空间与内核空间并不需要数据拷贝，因此在正确使用情况下并不比 sendfile 效率差；</li>
</ol>
<h2 id="6-补充"><a href="#6-补充" class="headerlink" title="6. 补充"></a>6. 补充</h2><p>mmap 代码案例可参考此 issue：<a target="_blank" rel="noopener" href="https://github.com/Spongecaptain/SimpleClearFileIO/issues/1">mmap 代码补充</a></p>
<h2 id="REFERENCE"><a href="#REFERENCE" class="headerlink" title="REFERENCE"></a>REFERENCE</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huxiao-tee/p/4660352.html">认真分析mmap：是什么 为什么 怎么用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/48161206">Linux 中 mmap() 函数的内存映射问题理解？</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/258091/when-should-i-use-mmap-for-file-access">When should I use mmap for file access?</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/308054212">Linux I/O 原理和 Zero-copy 技术全面揭秘 - 知乎</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2023/02/04/2.%20DMA%20%E4%B8%8E%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/04/2.%20DMA%20%E4%B8%8E%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-02-04 10:34:09 / 修改时间：10:33:07" itemprop="dateCreated datePublished" datetime="2023-02-04T10:34:09+08:00">2023-02-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="DMA-与零拷贝技术"><a href="#DMA-与零拷贝技术" class="headerlink" title="DMA 与零拷贝技术"></a>DMA 与零拷贝技术</h1><blockquote>
<p><strong>注意事项</strong>：除了 Direct I/O，与磁盘相关的文件读写操作都有使用到 page cache 技术。 </p>
</blockquote>
<h2 id="1-数据的四次拷贝与四次上下文切换"><a href="#1-数据的四次拷贝与四次上下文切换" class="headerlink" title="1. 数据的四次拷贝与四次上下文切换"></a>1. 数据的四次拷贝与四次上下文切换</h2><p>很多应用程序在面临客户端请求时，可以等价为进行如下的系统调用：</p>
<ol>
<li>File.read(file, buf, len);</li>
<li>Socket.send(socket, buf, len);</li>
</ol>
<p>例如消息中间件 Kafka 就是这个应用场景，从磁盘中读取一批消息后原封不动地写入网卡（NIC，Network interface controller）进行发送。</p>
<p>在没有任何优化技术使用的背景下，操作系统为此会进行 4 次数据拷贝，以及 4 次上下文切换，如下图所示：</p>
<p><img src="images/NoOptimization.jpg" alt="NoOptimization"></p>
<p>如果没有优化，读取磁盘数据，再通过网卡传输的场景性能比较差：</p>
<p>4 次 copy：</p>
<ul>
<li>物理设备 &lt;-&gt; 内存：<ul>
<li>CPU 负责将数据从磁盘搬运到内核空间的 Page Cache 中；</li>
<li>CPU 负责将数据从内核空间的 Socket 缓冲区搬运到的网络中；</li>
</ul>
</li>
<li>内存内部拷贝：<ul>
<li>CPU 负责将数据从内核空间的 Page Cache 搬运到用户空间的缓冲区；</li>
<li>CPU 负责将数据从用户空间的缓冲区搬运到内核空间的 Socket 缓冲区中；</li>
</ul>
</li>
</ul>
<p>4 次上下文切换：</p>
<ol>
<li>read 系统调用时：用户态切换到内核态；</li>
<li>read 系统调用完毕：内核态切换回用户态；</li>
<li>write 系统调用时：用户态切换到内核态；</li>
<li>write 系统调用完毕：内核态切换回用户态；</li>
</ol>
<p>我们不免发出抱怨：</p>
<ol>
<li>CPU 全程负责内存内部的数据拷贝还可以接受，因为内存的数据拷贝效率还行（不过还是比 CPU 慢很多），但是如果要 CPU 全程负责内存与磁盘、内存与网卡的数据拷贝，这将难以接受，因为磁盘、网卡的 I/O 速度远小于内存；</li>
<li>4 次 copy 太多了，4 次上下文切换也太频繁了；</li>
</ol>
<h2 id="2-DMA-参与下的数据四次拷贝"><a href="#2-DMA-参与下的数据四次拷贝" class="headerlink" title="2. DMA 参与下的数据四次拷贝"></a>2. DMA 参与下的数据四次拷贝</h2><p>DMA 技术很容易理解，本质上，DMA 技术就是我们在主板上放一块独立的芯片。在进行内存和 I/O 设备的数据传输的时候，我们不再通过 CPU 来控制数据传输，而直接通过 DMA 控制器（DMA Controller，简称 DMAC）。这块芯片，我们可以认为它其实就是一个协处理器（Co-Processor）。</p>
<p>DMAC 的价值在如下情况中尤其明显：当我们要传输的数据特别大、速度特别快，或者传输的数据特别小、速度特别慢的时候。</p>
<p>比如说，我们用千兆网卡或者硬盘传输大量数据的时候，如果都用 CPU 来搬运的话，肯定忙不过来，所以可以选择 DMAC。而当数据传输很慢的时候，DMAC 可以等数据到齐了，再发送信号，给到 CPU 去处理，而不是让 CPU 在那里忙等待。</p>
<p><strong>注意</strong>：这里面的“协”字。DMAC 是在“协助”CPU，完成对应的数据传输工作。在 DMAC 控制数据传输的过程中，DMAC 还是被 CPU 控制，只是数据的拷贝行为不再由 CPU 来完成。</p>
<p>原本，计算机所有组件之间的数据拷贝（流动）必须经过 CPU。以磁盘读写为例，如下图所示：</p>
<img src="./images/image-20210202234430674.png" alt="image-20210202234430674" style="zoom: 33%;" />

<p>现在，DMAC 代替了 CPU 负责内存与磁盘、内存与网卡之间的数据搬运，CPU 作为 DMAC 的控制者，如下图所示：</p>
<img src="./images/image-20210202234656779.png" alt="image-20210202234656779" style="zoom:33%;" />

<p>但是 DMAC 有其局限性，DMAC 仅仅能用于设备<strong>间</strong>交换数据时进行数据拷贝，但是<strong>设备内部的数据拷贝还需要 CPU 来亲力亲为</strong>。例如， CPU 需要负责内核空间与用户空间之间的数据拷贝（内存内部的拷贝），如下图所示：</p>
<img src="./images/image-20210202233454550.png" alt="image-20210202233454550" style="zoom: 50%;" />

<p>上图中的 read buffer 也就是 page cache，socket buffer 也就是 Socket 缓冲区。</p>
<h2 id="3-零拷贝技术"><a href="#3-零拷贝技术" class="headerlink" title="3. 零拷贝技术"></a>3. 零拷贝技术</h2><h3 id="3-1-什么是零拷贝技术？"><a href="#3-1-什么是零拷贝技术？" class="headerlink" title="3.1 什么是零拷贝技术？"></a>3.1 什么是零拷贝技术？</h3><p>零拷贝技术是一个思想[3]，指的是指计算机执行操作时，CPU 不需要先将数据从某处内存复制到另一个特定区域。</p>
<p>可见，零拷贝的特点是 CPU 不全程负责内存中的数据写入其他组件，CPU 仅仅起到管理的作用。但注意，零拷贝不是不进行拷贝，而是 CPU 不再全程负责数据拷贝时的搬运工作。如果数据本身不在内存中，那么必须先通过某种方式拷贝到内存中（这个过程 CPU 可以仅仅负责管理，DMAC 来负责具体数据拷贝），因为数据只有在内存中，才能被转移，才能被 CPU 直接读取计算。</p>
<p>零拷贝技术的具体实现方式有很多，例如：</p>
<ul>
<li>sendfile</li>
<li>mmap</li>
<li>直接 Direct I/O</li>
<li>splice</li>
</ul>
<p>不同的零拷贝技术适用于不同的应用场景，下面依次进行 sendfile、mmap、Direct I/O 的分析。</p>
<p>不过，我们不妨先在这里做一个前瞻性的技术总结。</p>
<ul>
<li>DMA 技术：DMA 负责内存与其他组件之间的数据拷贝，CPU 仅需负责管理，而无需负责全程的数据拷贝；</li>
<li>使用 page cache 的 zero copy：<ul>
<li>sendfile：一次代替 read/write 系统调用，通过使用 DMA 技术以及传递文件描述符，实现了 zero copy</li>
<li>mmap：仅代替 read 系统调用，将内核空间地址映射为用户空间地址，write 操作直接作用于内核空间。通过 DMA 技术以及地址映射技术，用户空间与内核空间无须数据拷贝，实现了 zero copy</li>
</ul>
</li>
<li>不使用 page cache 的 Direct I/O：读写操作直接在磁盘上进行，不使用 page cache 机制，通常结合用户空间的用户缓存使用。通过 DMA 技术直接与磁盘/网卡进行数据交互，实现了 zero copy</li>
</ul>
<h3 id="3-2-sendfile"><a href="#3-2-sendfile" class="headerlink" title="3.2 sendfile"></a>3.2 sendfile</h3><p>snedfile 的应用场景是：<strong>用户从磁盘读取一些文件数据后不需要经过任何计算与处理就通过网络传输出去</strong>。此场景的典型应用是消息队列。</p>
<p>在传统 I/O 下，正如第一节所示，上述应用场景的一次数据传输需要四次 CPU 全权负责的拷贝与四次上下文切换，正如本文第一节所述。</p>
<p>sendfile 主要使用到了两个技术：</p>
<ol>
<li>DMA 技术；</li>
<li>传递文件描述符代替数据拷贝；</li>
</ol>
<p>下面依次讲解这两个技术的作用。</p>
<p><strong>1.利用 DMA 技术</strong></p>
<p>sendfile 依赖于 DMA 技术，将四次 CPU 全程负责的拷贝与四次上下文切换减少到两次，如下图所示：</p>
<img src="./images/v2-8e275190c982f08d06bc5e629f8b8215_1440w.jpg" alt="img" style="zoom:67%;" />

<blockquote>
<p>利用 DMA 技术减少 2 次 CPU 全程参与的拷贝</p>
</blockquote>
<p>DMA 负责磁盘到内核空间中的 Page cache（read buffer）的数据拷贝以及从内核空间中的 socket buffer 到网卡的数据拷贝。</p>
<p><strong>2.传递文件描述符代替数据拷贝</strong></p>
<p>传递文件描述可以代替数据拷贝，这是由于两个原因：</p>
<ul>
<li>page cache 以及 socket buffer 都在内核空间中；</li>
<li>数据在传输中没有被更新；</li>
</ul>
<img src="./images/v2-c8a276f3cece45e8b66a2a1344e0cd54_1440w.jpg" alt="img" style="zoom:50%;" />

<blockquote>
<p>利用传递文件描述符代替内核中的数据拷贝</p>
</blockquote>
<p><strong>注意事项</strong>：只有网卡支持 SG-DMA（The Scatter-Gather Direct Memory Access）技术才可以通过传递文件描述符的方式避免内核空间内的一次 CPU 拷贝。这意味着此优化取决于 Linux 系统的物理网卡是否支持（Linux 在内核 2.4 版本里引入了 DMA 的 scatter/gather – 分散/收集功能，只要确保 Linux 版本高于 2.4 即可）。</p>
<p><strong>3.一次系统调用代替两次系统调用</strong></p>
<p>由于 sendfile 仅仅对应一次系统调用，而传统文件操作则需要使用 read 以及 write 两个系统调用。</p>
<p>正因为如此，sendfile 能够将用户态与内核态之间的上下文切换从 4 次讲到 2 次。</p>
<p><img src="images/sendfile.jpg" alt="sendfile"></p>
<blockquote>
<p>sendfile 系统调用仅仅需要两次上下文切换</p>
</blockquote>
<p>另一方面，我们需要注意 sendfile 系统调用的局限性。如果应用程序需要对从磁盘读取的数据进行写操作，例如解密或加密，那么 sendfile 系统调用就完全没法用。这是因为用户线程根本就不能够通过 sendfile 系统调用得到传输的数据。</p>
<h3 id="3-3-mmap"><a href="#3-3-mmap" class="headerlink" title="3.3 mmap"></a>3.3 mmap</h3><p>mmap 技术在[4] 中单独展开，请移步阅读。</p>
<h3 id="3-4-Direct-I-O"><a href="#3-4-Direct-I-O" class="headerlink" title="3.4 Direct I/O"></a>3.4 Direct I/O</h3><p>Direct I/O 即直接 I/O。其名字中的”直接”二字用于区分使用 page cache 机制的缓存 I/O。</p>
<ul>
<li>缓存文件 I/O：用户空间要读写一个文件并<strong>不直接</strong>与磁盘交互，而是中间夹了一层缓存，即 page cache；</li>
<li>直接文件 I/O：用户空间读取的文件<strong>直接</strong>与磁盘交互，没有中间 page cache 层；</li>
</ul>
<p>“直接”在这里还有另一层语义：其他所有技术中，数据至少需要在内核空间存储一份，但是在 Direct I/O 技术中，数据直接存储在用户空间中，绕过了内核。</p>
<p>Direct I/O 模式如下图所示：</p>
<p><img src="images/directIO.jpg" alt="directIO"></p>
<blockquote>
<p>Direct I/O 示意图</p>
</blockquote>
<p>此时用户空间直接通过 DMA 的方式与磁盘以及网卡进行数据拷贝。</p>
<p><strong>Direct I/O 的读写非常有特点</strong>：</p>
<ul>
<li>Write 操作：由于其不使用 page cache，所以其进行写文件，如果返回成功，数据就真的落盘了（不考虑磁盘自带的缓存）；</li>
<li>Read 操作：由于其不使用 page cache，每次读操作是真的从磁盘中读取，不会从文件系统的缓存中读取。</li>
</ul>
<p><strong>事实上，即使 Direct I/O 还是可能需要使用操作系统的 fsync 系统调用。为什么？</strong></p>
<p>这是因为虽然文件的数据本身没有使用任何缓存，但是文件的元数据仍然需要缓存，包括 VFS 中的 inode cache 和 dentry cache 等。</p>
<p>在部分操作系统中，在 Direct I/O 模式下进行 write 系统调用能够确保文件数据落盘，但是文件元数据不一定落盘。如果在此类操作系统上，那么还需要执行一次 fsync 系统调用确保文件元数据也落盘。否则，可能会导致文件异常、元数据确实等情况。MySQL 的 O_DIRECT 与 O_DIRECT_NO_FSYNC 配置是一个具体案例[9]。</p>
<p>Direct I/O 的优缺点：</p>
<p><strong>（1）优点</strong></p>
<ol>
<li>Linux 中的直接 I/O 技术省略掉缓存 I/O 技术中操作系统内核缓冲区的使用，数据直接在应用程序地址空间和磁盘之间进行传输，从而使得自缓存应用程序可以省略掉复杂的系统级别的缓存结构，而执行程序自己定义的数据读写管理，从而<strong>降低系统级别的管理对应用程序访问数据的影响</strong>。</li>
<li>与其他零拷贝技术一样，避免了内核空间到用户空间的数据拷贝，如果要传输的数据量很大，使用直接 I/O 的方式进行数据传输，而不需要操作系统内核地址空间拷贝数据操作的参与，这将会大大提高性能。</li>
</ol>
<p><strong>（2）缺点</strong></p>
<ol>
<li>由于设备之间的数据传输是通过 DMA 完成的，因此<strong>用户空间的数据缓冲区内存页必须进行 page pinning（页锁定）</strong>，这是为了防止其物理页框地址被交换到磁盘或者被移动到新的地址而导致 DMA 去拷贝数据的时候在指定的地址找不到内存页从而引发缺页错误，而页锁定的开销并不比 CPU 拷贝小，所以为了避免频繁的页锁定系统调用，应用程序必须分配和注册一个持久的内存池，用于数据缓冲。</li>
<li>如果访问的数据不在应用程序缓存中，那么每次数据都会直接从磁盘进行加载，这种直接加载会非常缓慢。</li>
<li>在应用层引入直接 I/O 需要应用层自己管理，这带来了额外的系统复杂性；</li>
</ol>
<p><strong>谁会使用 Direct I/O？</strong></p>
<p>IBM[5]的一篇文章指出，自缓存应用程序（ self-caching applications）可以选择使用 Direct I/O。</p>
<blockquote>
<p>自缓存应用程序</p>
<p>对于某些应用程序来说，它会有它自己的数据缓存机制，比如，它会将数据缓存在应用程序地址空间，这类应用程序完全不需要使用操作系统内核中的高速缓冲存储器，这类应用程序就被称作是自缓存应用程序（ self-caching applications ）。</p>
<p>例如，应用内部维护一个缓存空间，当有读操作时，首先读取应用层的缓存数据，如果没有，那么就通过 Direct I/O 直接通过磁盘 I/O 来读取数据。缓存仍然在应用，只不过应用觉得自己实现一个缓存比操作系统的缓存更高效。</p>
<p><strong>数据库管理系统是这类应用程序的一个代表</strong>。自缓存应用程序倾向于使用数据的逻辑表达方式，而非物理表达方式；当系统内存较低的时候，自缓存应用程序会让这种数据的逻辑缓存被换出，而并非是磁盘上实际的数据被换出。自缓存应用程序对要操作的数据的语义了如指掌，所以它可以采用更加高效的缓存替换算法。自缓存应用程序有可能会在多台主机之间共享一块内存，那么自缓存应用程序就需要提供一种能够有效地将用户地址空间的缓存数据置为无效的机制，从而确保应用程序地址空间缓存数据的一致性。</p>
<p>page cache 是 Linux 为所有应用提供的缓存机制，但是数据库应用太特殊了，page cache 影响了数据对特性的追求。</p>
</blockquote>
<p>另一方面，目前 Linux 上的异步 IO 库，其依赖于文件使用 O_DIRECT 模式打开，它们通常一起配合使用。</p>
<p><strong>如何使用 Direct I/O？</strong></p>
<p>用户应用需要实现用户空间内的缓存区，读/写操作应当尽量通过此缓存区提供。如果有性能上的考虑，那么尽量避免频繁地基于 Direct I/O 进行读/写操作。</p>
<h2 id="4-典型案例"><a href="#4-典型案例" class="headerlink" title="4. 典型案例"></a>4. 典型案例</h2><h3 id="4-1-Kakfa"><a href="#4-1-Kakfa" class="headerlink" title="4.1 Kakfa"></a>4.1 Kakfa</h3><p>Kafka 作为一个消息队列，涉及到磁盘 I/O 主要有两个操作：</p>
<ul>
<li>Provider 向 Kakfa 发送消息，Kakfa 负责将消息以日志的方式持久化落盘；</li>
<li>Consumer 向 Kakfa 进行拉取消息，Kafka 负责从磁盘中读取一批日志消息，然后再通过网卡发送；</li>
</ul>
<p>Kakfa 服务端接收 Provider 的消息并持久化的场景下使用 mmap 机制[6]，能够基于顺序磁盘 I/O 提供高效的持久化能力，使用的 Java 类为 java.nio.MappedByteBuffer。</p>
<p>Kakfa 服务端向 Consumer 发送消息的场景下使用 sendfile 机制[7]，这种机制主要两个好处：</p>
<ul>
<li>sendfile 避免了内核空间到用户空间的 CPU 全程负责的数据移动；</li>
<li>sendfile 基于 Page Cache 实现，因此如果有多个 Consumer 在同时消费一个主题的消息，那么由于消息一直在 page cache 中进行了缓存，因此只需一次磁盘 I/O，就可以服务于多个 Consumer；</li>
</ul>
<blockquote>
<p>使用 mmap 来对接收到的数据进行持久化，使用 sendfile 从持久化介质中读取数据然后对外发送是一对常用的组合。但是注意，你无法利用 sendfile 来持久化数据，利用 mmap 来实现 CPU 全程不参与数据搬运的数据拷贝。</p>
</blockquote>
<h3 id="4-2-MySQL"><a href="#4-2-MySQL" class="headerlink" title="4.2 MySQL"></a>4.2 MySQL</h3><p>MySQL 的具体实现比 Kakfa 复杂很多，这是因为支持 SQL 查询的数据库本身比消息队列对复杂很多。</p>
<p>MySQL 的零拷贝技术使用方式请移步我的另一篇文章[8]。</p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>DMA 技术使得内存与其他组件，例如磁盘、网卡进行数据拷贝时，CPU 仅仅需要发出控制信号，而拷贝数据的过程则由 DMAC 负责完成。</p>
<p>Linux 的零拷贝技术有多种实现策略，但根据策略可以分为如下几种类型：</p>
<ul>
<li><strong>减少甚至避免用户空间和内核空间之间的数据拷贝</strong>：在一些场景下，用户进程在数据传输过程中并不需要对数据进行访问和处理，那么数据在 Linux 的 <code>Page Cache</code> 和用户进程的缓冲区之间的传输就完全可以避免，让数据拷贝完全在内核里进行，甚至可以通过更巧妙的方式避免在内核里的数据拷贝。这一类实现一般是是通过增加新的系统调用来完成的，比如 Linux 中的 mmap()，sendfile() 以及 splice() 等。</li>
<li><strong>绕过内核的直接 I/O</strong>：允许在用户态进程绕过内核直接和硬件进行数据传输，内核在传输过程中只负责一些管理和辅助的工作。这种方式其实和第一种有点类似，也是试图避免用户空间和内核空间之间的数据传输，只是第一种方式是把数据传输过程放在内核态完成，而这种方式则是直接绕过内核和硬件通信，效果类似但原理完全不同。</li>
<li><strong>内核缓冲区和用户缓冲区之间的传输优化</strong>：这种方式侧重于在用户进程的缓冲区和操作系统的页缓存之间的 CPU 拷贝的优化。这种方法延续了以往那种传统的通信方式，但更灵活。</li>
</ul>
<h1 id="REFERENCE"><a href="#REFERENCE" class="headerlink" title="REFERENCE"></a>REFERENCE</h1><ul>
<li>[1]<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/272200286">CPU：一个故事看懂DMA</a></li>
<li>[2]<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/308054212">Linux I/O 原理和 Zero-copy 技术全面揭秘</a></li>
<li>[3]<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%B6%E5%A4%8D%E5%88%B6">零复制 - 维基百科，自由的百科全书</a></li>
<li>[4][mmap](<a target="_blank" rel="noopener" href="https://spongecaptain.cool/SimpleClearFileIO/3">https://spongecaptain.cool/SimpleClearFileIO/3</a>. mmap.html)</li>
<li>[5]<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-cn-directio/">直接 I/O 的动机</a></li>
<li>[6]<a target="_blank" rel="noopener" href="https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/log/AbstractIndex.scala">kafka.log.AbstractIndex</a></li>
<li>[7]<a target="_blank" rel="noopener" href="https://kafka.apache.org/08/documentation.html">Apache Kafka DOCUMENTATION</a></li>
<li>[8]<a target="_blank" rel="noopener" href="https://spongecaptain.cool/post/mysql/zerocopyofmysql/">MySQL 的零拷贝技术</a></li>
<li>[9]<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html">InnoDB Startup Options and System Variables</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2023/02/04/10.%20RDMA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/04/10.%20RDMA/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-02-04 10:34:09 / 修改时间：10:33:07" itemprop="dateCreated datePublished" datetime="2023-02-04T10:34:09+08:00">2023-02-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="RDMA"><a href="#RDMA" class="headerlink" title="RDMA"></a>RDMA</h1><p>[toc]</p>
<h2 id="1-什么是-RDMA"><a href="#1-什么是-RDMA" class="headerlink" title="1. 什么是 RDMA"></a>1. 什么是 RDMA</h2><p>RDMA 即 Remote Direct Memory Access，其区别于 DMA（Direct Memory Access）。在数据中心领域，RDMA 是一种绕过远程主机操作系统内核访问其内存中数据的技术，由于不经过操作系统，不仅节省了大量 CPU 资源，同样也提高了系统吞吐量、降低了系统的网络通信延迟，尤其适合在大规模并行计算机集群中有广泛应用。在基于 NVMe over Fabric 的数据中心中，RDMA 可以配合高性能的 NVMe SSD 构建高性能、低延迟的存储网络[1]。</p>
<p>RDMA 技术基于 DMA 技术的硬件技术实现，此项技术特点在于在于不需要 CPU 干预而直接访问远程主机内存（应当说成 CPU 不需要负责数据搬运，仅仅需要管理），重点是为解决网络传输中服务器端数据处理的延迟。</p>
<h2 id="2-RDMA-的技术"><a href="#2-RDMA-的技术" class="headerlink" title="2. RDMA 的技术"></a>2. RDMA 的技术</h2><p>总之，RDMA 技术使得两个远程主机之间避免了：</p>
<ul>
<li>CPU 负责的数据搬运，其属于零拷贝技术的一种；</li>
<li>数据无需进入内核空间，直接通过网卡传输；</li>
</ul>
<p><img src="images/12RDMA05.png" alt="img"></p>
<p>上图清晰地说明了传统通过 Socket 传输的数据，虽然可以实现零拷贝，但是并不能够避免 TCP、IP 层的参与，需要复杂的报头处理逻辑。</p>
<p>但是 RDMA 由于直接通过底层的网络进行数据传输，因此避免了数据在内核空间的报文处理消耗以及数据拷贝消耗。</p>
<h2 id="REFERENCE"><a href="#REFERENCE" class="headerlink" title="REFERENCE"></a>REFERENCE</h2><ul>
<li>[1] <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BF%9C%E7%A8%8B%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E8%AE%BF%E9%97%AE">远程直接内存访问</a></li>
<li>[2] <a target="_blank" rel="noopener" href="https://www.sdnlab.com/23769.html">从天猫双11成交额2684亿看RDMA网络</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2023/01/19/2-asyncio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/19/2-asyncio/" class="post-title-link" itemprop="url">1.并发使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-19 10:30:53" itemprop="dateCreated datePublished" datetime="2023-01-19T10:30:53+08:00">2023-01-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 21:14:55" itemprop="dateModified" datetime="2023-07-16T21:14:55+08:00">2023-07-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="asyncio异步编程"><a href="#asyncio异步编程" class="headerlink" title="asyncio异步编程"></a>asyncio异步编程</h2><h3 id="python异步库"><a href="#python异步库" class="headerlink" title="python异步库"></a>python异步库</h3><p><a target="_blank" rel="noopener" href="https://github.com/aio-libs">https://github.com/aio-libs</a></p>
<h3 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h3><p>是一个实现了迭代器协议的对象，python的一些内置数据类型（列表，数组，字符串，字典等）都可以通过for语句进行迭代，我们也可以自己创建一个容器，实现了迭代器协议，可以通过for，next方法进行迭代，在迭代的末尾，会引发stopIteration异常。实现了__iter__和__next__方法</p>
<h3 id="生成器（generator）【一种特殊迭代器】"><a href="#生成器（generator）【一种特殊迭代器】" class="headerlink" title="生成器（generator）【一种特殊迭代器】"></a>生成器（generator）【一种特殊迭代器】</h3><ol>
<li>是通过yield语句快速生成迭代器，可以不用iter和next方法</li>
<li>yield可以使一个普通函数变成一个生成器，并且相应的next()方法返回是yield后的值。一种更直观的解释是：程序执行到yield时会返回结果并暂停，再次调用next时会从上次暂停的地方继续开始执行。</li>
<li>生成器自身有构成一个迭代器，每次迭代时使用一个yield返回 的值，一个生成器中可以有多个yield的值</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fibonacci</span>(<span class="params">n</span>):</span> <span class="comment"># 生成器函数 - 斐波那契</span></span><br><span class="line">    a, b, counter = <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (counter &gt; n):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">yield</span> a</span><br><span class="line">        a, b = b, a + b</span><br><span class="line">        counter += <span class="number">1</span></span><br><span class="line">f = fibonacci(<span class="number">10</span>) <span class="comment"># f 是一个迭代器，由生成器返回生成</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="built_in">next</span>(f), end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        sys.exit()</span><br><span class="line"><span class="string">&quot;&quot;&quot;结果0 1 1 2 3 5 8 13 21 34 55&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="python异步编程原理"><a href="#python异步编程原理" class="headerlink" title="python异步编程原理"></a>python异步编程原理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1.遍历url 生成对应的协程对象，并将该对象协程fetch方法，放入task中</span></span><br><span class="line"><span class="string">2.task 初始化future 开启协程，并将step函数（协程触发函数放到future的回调属性中），并将socker 注册对应future的set_result 该方法会设置结果，并且触发回调</span></span><br><span class="line"><span class="string">3.开启ioloop 当发现了事件之后，调用事件的回调函数，通过set_result 完成，向下执行程序</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">为了节省网络IO时间，通过5种IO模型中的io多路复用，达到节省网络IO到达的时间的目的，其实根本目的是为了节省等待数据准备 (Waiting for the data to be ready)的时间，但是从内核写到用户进程的时间还是会阻塞的</span></span><br><span class="line"><span class="string">loop 不断轮训发生的事件，并且执行注册在selector上的回调函数</span></span><br><span class="line"><span class="string">        这里的回调函数一方面为Future 对象的result赋值，另一方面执行Task中的step 函数用于驱动协程的执行</span></span><br><span class="line"><span class="string">Future 保存将来的执行结果，配合Task ，协程函数完成回调的执行</span></span><br><span class="line"><span class="string">Task 触发器</span></span><br><span class="line"><span class="string">协程函数： 执行注册监听到selector上，并配合事件回调循环</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">selector = DefaultSelector</span><br><span class="line">stopped = <span class="literal">False</span></span><br><span class="line">urls_todo = &#123;<span class="string">&#x27;www.baidu.com&#x27;</span>, <span class="string">&#x27;www.baidu.com/1&#x27;</span>, <span class="string">&#x27;/2&#x27;</span>, <span class="string">&#x27;/3&#x27;</span>, <span class="string">&#x27;/4&#x27;</span>, <span class="string">&#x27;/5&#x27;</span>, <span class="string">&#x27;/6&#x27;</span>, <span class="string">&#x27;/7&#x27;</span>, <span class="string">&#x27;/8&#x27;</span>, <span class="string">&#x27;/9&#x27;</span>&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Future</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.result = <span class="literal">None</span></span><br><span class="line">        self._callbacks = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_done_callback</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self._callbacks.append(fn)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_result</span>(<span class="params">self, result</span>):</span></span><br><span class="line">        self.result = result</span><br><span class="line">        <span class="keyword">for</span> fn <span class="keyword">in</span> self._callbacks:</span><br><span class="line">            fn(self)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, url</span>):</span></span><br><span class="line">        self.url = url</span><br><span class="line">        self.response = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">self</span>):</span></span><br><span class="line">        sock = socket.socket()</span><br><span class="line">        sock.setblocking(<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;****&#x27;</span>*<span class="number">50</span>)</span><br><span class="line">            sock.connect((<span class="string">&#x27;220.181.111.148&#x27;</span>, <span class="number">80</span>))</span><br><span class="line">        <span class="keyword">except</span> BlockingIOError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        f = Future()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;++++&quot;</span>*<span class="number">50</span>)</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">on_connected</span>():</span></span><br><span class="line">            f.set_result(<span class="literal">None</span>)</span><br><span class="line">        <span class="built_in">print</span>(sock.fileno())</span><br><span class="line">        selector.register(sock.fileno(), EVENT_WRITE, on_connected)</span><br><span class="line">        <span class="keyword">yield</span> f</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;yield 之后了&quot;</span>)</span><br><span class="line">        selector.unregister(sock.fileno())</span><br><span class="line">        get = <span class="string">&#x27;GET &#123;0&#125; HTTP/1.0\r\nHost: 220.181.111.148\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(self.url)</span><br><span class="line">        sock.send(get.encode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> stopped</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            f = Future()</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">on_readable</span>():</span></span><br><span class="line">                f.set_result(sock.recv(<span class="number">4096</span>))</span><br><span class="line"></span><br><span class="line">            selector.register(sock.fileno(), EVENT_READ, on_readable)</span><br><span class="line">            chunk = <span class="keyword">yield</span> f</span><br><span class="line">            selector.unregister(sock.fileno())</span><br><span class="line">            <span class="keyword">if</span> chunk:</span><br><span class="line">                self.response += chunk</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                urls_todo.remove(self.url)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> urls_todo:</span><br><span class="line">                    stopped = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, coro</span>):</span></span><br><span class="line">        self.coro = coro</span><br><span class="line">        f = Future()</span><br><span class="line">        f.set_result(<span class="literal">None</span>)</span><br><span class="line">        self.step(f)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">step</span>(<span class="params">self, future</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            next_future = self.coro.send(future.result)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;停止task&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        next_future.add_done_callback(self.step)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stopped:</span><br><span class="line">        events = selector.select()</span><br><span class="line">        <span class="keyword">for</span> event_key, event_mask <span class="keyword">in</span> events:</span><br><span class="line">            callback = event_key.data</span><br><span class="line">            callback()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls_todo:</span><br><span class="line">        crawler = Crawler(url)</span><br><span class="line">        Task(crawler.fetch())</span><br><span class="line">    loop()</span><br><span class="line">    <span class="built_in">print</span>(time.time() - start)</span><br></pre></td></tr></table></figure>

<h3 id="asyncio-使用讲解"><a href="#asyncio-使用讲解" class="headerlink" title="asyncio 使用讲解"></a>asyncio 使用讲解</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvloop <span class="comment"># 这个效率更高</span></span><br><span class="line">asyncio.set_event_loop_policy(uvloop.EventLoopPolicy())</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">testa</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;in test a&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;a 又开始了&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">testb</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;in test b&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;b 又开始了&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callbackfunc</span>(<span class="params">task</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;回调函数，运行结果为&#123;&#125;&quot;</span>.<span class="built_in">format</span>(task.result()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main1</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;顺序执行，串行</span></span><br><span class="line"><span class="string">    in test a</span></span><br><span class="line"><span class="string">    a 又开始了</span></span><br><span class="line"><span class="string">    in test b</span></span><br><span class="line"><span class="string">    b 又开始了</span></span><br><span class="line"><span class="string">    test a result is a</span></span><br><span class="line"><span class="string">    test b result is b</span></span><br><span class="line"><span class="string">    一共耗时为：4.002900838851929</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    start =time.time()</span><br><span class="line">    a_result = <span class="keyword">await</span> testa(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    b_result = <span class="keyword">await</span> testb(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test a result is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(a_result))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test b result is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(b_result))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;一共耗时为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(time.time()-start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main2</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;并行执行</span></span><br><span class="line"><span class="string">    in test a</span></span><br><span class="line"><span class="string">    in test b</span></span><br><span class="line"><span class="string">    b 又开始了</span></span><br><span class="line"><span class="string">    a 又开始了</span></span><br><span class="line"><span class="string">    test a result is a</span></span><br><span class="line"><span class="string">    test b result is b</span></span><br><span class="line"><span class="string">    一共耗时为：3.0003840923309326</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    a_result,b_result = <span class="keyword">await</span> asyncio.gather(testa(<span class="string">&quot;a&quot;</span>),testb(<span class="string">&quot;b&quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test a result is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(a_result))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test b result is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(b_result))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;一共耗时为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(time.time()-start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main3</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;通过创建task来进行并行执行</span></span><br><span class="line"><span class="string">    &lt;Task pending name=&#x27;Task-2&#x27; coro=&lt;testa() running at C:/Users/zx-176/PycharmProjects/untitled/2020/async/asyncio_test.py:4&gt;&gt;</span></span><br><span class="line"><span class="string">    &lt;Task pending name=&#x27;Task-3&#x27; coro=&lt;testb() running at C:/Users/zx-176/PycharmProjects/untitled/2020/async/asyncio_test.py:10&gt;&gt;</span></span><br><span class="line"><span class="string">    False False</span></span><br><span class="line"><span class="string">    in test a</span></span><br><span class="line"><span class="string">    in test b</span></span><br><span class="line"><span class="string">    b 又开始了</span></span><br><span class="line"><span class="string">    a 又开始了</span></span><br><span class="line"><span class="string">    True True</span></span><br><span class="line"><span class="string">    a</span></span><br><span class="line"><span class="string">    b</span></span><br><span class="line"><span class="string">    一共耗时为：3.000962257385254</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    start = time.time()</span><br><span class="line"></span><br><span class="line">    taska = asyncio.ensure_future(testa(<span class="string">&quot;a&quot;</span>))  <span class="comment"># 返回的是task对象</span></span><br><span class="line">    taskb = asyncio.ensure_future(testb(<span class="string">&quot;b&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(taska)</span><br><span class="line">    <span class="built_in">print</span>(taskb)</span><br><span class="line">    <span class="built_in">print</span>(taska.done(),taskb.done())</span><br><span class="line">    <span class="keyword">await</span> taska</span><br><span class="line">    <span class="keyword">await</span> taskb</span><br><span class="line">    <span class="built_in">print</span>(taska.done(),taskb.done())</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(taska.result())</span><br><span class="line">    <span class="built_in">print</span>(taskb.result())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;一共耗时为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(time.time() - start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main4</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;结果同3&quot;&quot;&quot;</span></span><br><span class="line">    start = time.time()</span><br><span class="line"></span><br><span class="line">    taska = asyncio.create_task(testa(<span class="string">&quot;a&quot;</span>))  <span class="comment"># 返回task对象</span></span><br><span class="line">    <span class="comment"># task对象可以增加回调函数</span></span><br><span class="line">    taska.add_done_callback(callbackfunc)</span><br><span class="line">    taskb = asyncio.create_task(testb(<span class="string">&quot;b&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(taska)</span><br><span class="line">    <span class="built_in">print</span>(taskb)</span><br><span class="line">    <span class="built_in">print</span>(taska.done(),taskb.done())</span><br><span class="line">    <span class="keyword">await</span> taska</span><br><span class="line">    <span class="keyword">await</span> taskb</span><br><span class="line">    <span class="built_in">print</span>(taska.done(),taskb.done())</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(taska.result())</span><br><span class="line">    <span class="built_in">print</span>(taskb.result())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;一共耗时为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(time.time() - start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(main4())</span><br><span class="line">    <span class="comment"># loop = asyncio.get_event_loop()</span></span><br><span class="line">    <span class="comment"># loop.run_until_complete(main1())</span></span><br></pre></td></tr></table></figure>

<h3 id="wait和gather区别"><a href="#wait和gather区别" class="headerlink" title="wait和gather区别"></a>wait和gather区别</h3><ol>
<li>首先，gather是需要所有任务都执行结束，如果某一个协程函数崩溃了，则会抛异常，都不会有结果。</li>
<li>wait可以定义函数返回的时机，可以是FIRST_COMPLETED(第一个结束的)，FIRST_EXCEPTION(第一个出现异常的)，ALL_COMPLETED(全部执行完，默认的)</li>
</ol>
<h3 id="如何使用线程池进程池对无法使用异步库的函数进行并发"><a href="#如何使用线程池进程池对无法使用异步库的函数进行并发" class="headerlink" title="如何使用线程池进程池对无法使用异步库的函数进行并发"></a>如何使用线程池进程池对无法使用异步库的函数进行并发</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor,ProcessPoolExecutor</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义阻塞函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;阻塞函数开始执行，当前进程ID为：&#123;&#125;，线程ID为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(),threading.current_thread()))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;模拟ping 输出:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(url))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;阻塞函数结束执行，当前进程ID为：&#123;&#125;，线程ID为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(),threading.current_thread()))</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义阻塞函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">ping2</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;阻塞函数开始执行，当前进程ID为：&#123;&#125;，线程ID为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(),threading.current_thread()))</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;模拟ping 输出:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(url))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;阻塞函数结束执行，当前进程ID为：&#123;&#125;，线程ID为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(),threading.current_thread()))</span><br><span class="line"><span class="comment">#定义一个跑事件循环的线程函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_thread_loop</span>(<span class="params">loop</span>):</span></span><br><span class="line">    asyncio.set_event_loop(loop)</span><br><span class="line">    loop.run_forever()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main0</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;没并发&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;in main 当前进程ID为：&#123;&#125;，线程ID为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(),threading.current_thread()))</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    t = threading.Thread(target=start_thread_loop,args=(loop,))</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line">    loop.call_soon_threadsafe(ping,<span class="string">&quot;www.baidu.com&quot;</span>)</span><br><span class="line">    loop.call_soon_threadsafe(ping, <span class="string">&quot;www.qq.com&quot;</span>)</span><br><span class="line">    loop.call_soon_threadsafe(ping, <span class="string">&quot;www.weixin.com&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;主线程不阻塞&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main1</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;均在不同线程中跑&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;in main 当前进程ID为：&#123;&#125;，线程ID为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(),threading.current_thread()))</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    t = threading.Thread(target=start_thread_loop,args=(loop,))</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line">    loop.run_in_executor(<span class="literal">None</span>,ping,<span class="string">&quot;www.baidu.com&quot;</span>)</span><br><span class="line">    loop.run_in_executor(<span class="literal">None</span>, ping, <span class="string">&quot;www.qq.com&quot;</span>)</span><br><span class="line">    loop.run_in_executor(<span class="literal">None</span>, ping, <span class="string">&quot;www.weixin.com&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;主线程不阻塞&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main2</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;in main 当前进程ID为：&#123;&#125;，线程ID为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(),threading.current_thread()))</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    t = threading.Thread(target=start_thread_loop,args=(loop,))</span><br><span class="line">    t.start()</span><br><span class="line">    thread_executor = ThreadPoolExecutor(<span class="number">3</span>)</span><br><span class="line">    process_executor= ProcessPoolExecutor(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    loop.run_in_executor(process_executor,ping,<span class="string">&quot;www.baidu.com&quot;</span>)</span><br><span class="line">    loop.run_in_executor(process_executor, ping, <span class="string">&quot;www.qq.com&quot;</span>)</span><br><span class="line">    loop.run_in_executor(process_executor, ping, <span class="string">&quot;www.weixin.com&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;主线程不阻塞&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main3</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;同进程同线程&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;in main 当前进程ID为：&#123;&#125;，线程ID为：&#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(),threading.current_thread()))</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    t = threading.Thread(target=start_thread_loop,args=(loop,))</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line">    asyncio.run_coroutine_threadsafe(ping2(<span class="string">&quot;www.baidu.com&quot;</span>),loop)</span><br><span class="line">    asyncio.run_coroutine_threadsafe(ping2(<span class="string">&quot;www.qq.com&quot;</span>), loop)</span><br><span class="line">    asyncio.run_coroutine_threadsafe(ping2(<span class="string">&quot;www.weixin.com&quot;</span>), loop)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;主线程不阻塞&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main3()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2022/08/16/5-iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/16/5-iptables/" class="post-title-link" itemprop="url">5.iptables</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-16 09:58:17" itemprop="dateCreated datePublished" datetime="2022-08-16T09:58:17+08:00">2022-08-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 21:14:55" itemprop="dateModified" datetime="2023-07-16T21:14:55+08:00">2023-07-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li>我们知道，linux 系统中有 route，用来和其他网络连接。如果没有它，linux 就无法和外部通信了</li>
<li>iptables 是一系列的规则，用来对内核中的数据进行处理。没有它，linux 可以正常工作，有了它，linux 可以对网络中的数据的操作更加多样化，可见 iptables 是一个辅助角色，可以让 linux 的网络系统更强大。</li>
<li>iptables 其实不是真正的防火墙，我们可以把它理解成一个客户端代理，用户通过 iptables 这个代理，将用户的安全设定执行到对应的”安全框架”中，这个”安全框架”才是真正的防火墙，这个框架的名字叫 netfilter</li>
<li>netfilter 才是防火墙真正的安全框架（framework），netfilter位于内核空间。</li>
<li>iptables 其实是一个命令行工具，位于用户空间，我们用这个工具操作真正的框架。</li>
<li>Netfilter是Linux操作系统核心层内部的一个数据包处理模块，它具有如下功能：<ul>
<li>网络地址转换(Network Address Translate)</li>
<li>数据包内容修改</li>
<li>数据包过滤的防火墙功能</li>
</ul>
</li>
<li>在 iptables 中 有两个概念：链（PREROUTING、INPUT、OUTPUT、FORWARD、POSTROUTING）和表（raw–&gt;mangle–&gt;nat–&gt;filter）</li>
</ul>
<h3 id="链"><a href="#链" class="headerlink" title="链"></a>链</h3><img src="/2022/08/16/5-iptables/%E9%93%BE.jpg" class="">

<p>总结一下，数据包先经过 PREOUTING，由该链确定数据包的走向：</p>
<ul>
<li>目的地址是本地，则发送到 INPUT，让INPUT决定是否接收下来送到用户空间，流程为①—&gt;②;</li>
<li>若满足 PREROUTING 的 nat 表上的转发规则，则发送给 FORWARD，然后再经过 POSTROUTING 发送出去，流程为： ①—&gt;③—&gt;④—&gt;⑥</li>
<li>主机发送数据包时，流程则是⑤—&gt;⑥</li>
</ul>
<p>标记</p>
<ul>
<li>ACCEPT：允许数据包通过。</li>
<li>DROP：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。</li>
<li>REJECT：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</li>
<li>SNAT：源地址转换，解决内网用户用同一个公网地址上网的问题。</li>
<li>MASQUERADE：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。</li>
<li>DNAT：目标地址转换。</li>
<li>REDIRECT：在本机做端口映射。</li>
<li>MARK：打标记。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -nvL  默认-t是filter</span><br><span class="line">iptables-save</span><br></pre></td></tr></table></figure>

<h3 id="表"><a href="#表" class="headerlink" title="表"></a>表</h3><img src="/2022/08/16/5-iptables/%E8%A1%A8.jpg" class="">

<p>每个表（tables）对应了一个特定的功能，有filter表（实现包过滤）、nat表（实现网络地址转换）、mangle表（实现包修改）、raw表（实现数据跟踪），不同的表中包含了不同的钩子函数，不同表的同一钩子函数具有一定的优先级：raw–&gt;mangle–&gt;nat–&gt;filter。</p>
<h3 id="删除iptables中规则"><a href="#删除iptables中规则" class="headerlink" title="删除iptables中规则"></a>删除iptables中规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n --line-number 查看记录号</span><br><span class="line">iptables -D INPUT 1      删除input表中第一条规则</span><br><span class="line"></span><br><span class="line">iptables -F</span><br><span class="line">iptables -Z</span><br><span class="line">iptables -X</span><br><span class="line">iptables -t nat -F  清空该表里所有</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2022/07/13/4-%E7%94%BB%E5%9B%BE%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/13/4-%E7%94%BB%E5%9B%BE%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">4.画图相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-13 18:56:42" itemprop="dateCreated datePublished" datetime="2022-07-13T18:56:42+08:00">2022-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-04 10:33:07" itemprop="dateModified" datetime="2023-02-04T10:33:07+08:00">2023-02-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>创建dataframe</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">柱形图</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">df.plot(kind=<span class="string">&#x27;bar&#x27;</span>, title=title)</span><br><span class="line">plt.xlabel(x_label)</span><br><span class="line">plt.ylabel(y_label)</span><br><span class="line">path = os.path.join(save_path, name)</span><br><span class="line">plt.savefig(path,bbox_inches=<span class="string">&quot;tight&quot;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2022/06/13/7-%E5%B8%B8%E8%A7%81%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/13/7-%E5%B8%B8%E8%A7%81%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">7.常见软件安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-13 11:07:07" itemprop="dateCreated datePublished" datetime="2022-06-13T11:07:07+08:00">2022-06-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-04 10:33:07" itemprop="dateModified" datetime="2023-02-04T10:33:07+08:00">2023-02-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="总"><a href="#总" class="headerlink" title="总"></a>总</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://zhangsnow.com/kernel/cgroups.html</span><br></pre></td></tr></table></figure>

<h3 id="go安装"><a href="#go安装" class="headerlink" title="go安装"></a>go安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mkdir  /usr/local/go</span><br><span class="line"></span><br><span class="line">cd /usr/local/go</span><br><span class="line"></span><br><span class="line">wget https://dl.google.com/go/go1.7.6.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">vi /etc/profile</span><br><span class="line">export GOROOT=/usr/local/go</span><br><span class="line">export PATH=/usr/local/go/bin:$PATH</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="hcache安装"><a href="#hcache安装" class="headerlink" title="hcache安装"></a>hcache安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://silenceshell-1255345740.cos.ap-shanghai.myqcloud.com/hcache</span><br><span class="line">chmod +x hcache</span><br><span class="line">mv hcache /usr/local/bin/</span><br><span class="line"></span><br><span class="line">hcache -top 3           查看使用缓存最多的3个文件</span><br><span class="line">hcache --top 3 --bname  查看使用缓存最多的3个文件（文件一列指显示文件名）</span><br><span class="line">hcache -pid 1397        查看指定进程的缓存使用</span><br></pre></td></tr></table></figure>

<h3 id="pc-stat安装"><a href="#pc-stat安装" class="headerlink" title="pc stat安装"></a>pc stat安装</h3><h3 id="raid信息查看"><a href="#raid信息查看" class="headerlink" title="raid信息查看"></a>raid信息查看</h3><ol>
<li></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2022/05/18/3-%E5%B8%B8%E8%A7%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/18/3-%E5%B8%B8%E8%A7%84%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">3.常规使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-18 11:31:27" itemprop="dateCreated datePublished" datetime="2022-05-18T11:31:27+08:00">2022-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 21:14:55" itemprop="dateModified" datetime="2023-07-16T21:14:55+08:00">2023-07-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="时间解析"><a href="#时间解析" class="headerlink" title="时间解析"></a>时间解析</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">from dateutil.parser import parse</span><br><span class="line">parse(a)</span><br><span class="line"></span><br><span class="line">def time_action(self,time_data,cut_seconds):</span><br><span class="line">&quot;&quot;&quot;时间戳加减秒操作&quot;&quot;&quot;</span><br><span class="line">pre_time = datetime.datetime.fromtimestamp(1659428736.1127937)</span><br><span class="line">now_time = datetime.timedelta(cut_seconds)+pre_time</span><br><span class="line">return now_time.</span><br><span class="line"></span><br><span class="line">import time</span><br><span class="line">import datetime</span><br><span class="line"><span class="meta">#</span><span class="bash">当前时间datetime</span></span><br><span class="line">now = datetime.datetime.now()</span><br><span class="line">print(&#x27;\n当前时间datetime：\t%s，类型：%s&#x27;%(now,type(now)))</span><br><span class="line"><span class="meta">#</span><span class="bash">当前时间str</span></span><br><span class="line">now_str = str(now)</span><br><span class="line">print(&#x27;当前时间str：\t\t%s，类型：%s&#x27;%(now_str,type(now_str)))</span><br><span class="line"><span class="meta">#</span><span class="bash">当前时间时间戳</span></span><br><span class="line">now_mktime =time.time()</span><br><span class="line">print(&#x27;当前时间时间戳：\t%s，类型：%s&#x27;%(now_mktime,type(now_mktime)))</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">今天、昨天、明天</span></span><br><span class="line">today = datetime.date.today()</span><br><span class="line">yesterday = today - datetime.timedelta(days=1)</span><br><span class="line">tommorrow = today + datetime.timedelta(days=1)</span><br><span class="line">print(&#x27;\n今天:%s,昨天:%s,明天：%s&#x27;%(today,yesterday,tomorrow))</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">任意时间字符串转为datetime</span></span><br><span class="line">today_8 = str(today)[0:10]+&#x27; 08:00:00&#x27;</span><br><span class="line">today_8_time = datetime.datetime.strptime(today_8,&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">print(&#x27;获取当天任意时间:&#x27;,today_8,&#x27;类型:&#x27;,type(today_8),today_8_time,&#x27;类型:&#x27;,type(today_8_time))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">datetime转为字符串</span></span><br><span class="line">now_str = datetime.datetime.strftime(now,&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">now_str_1 = str(now)[0:19]</span><br><span class="line">print(&#x27;\ndatetime转为字符串：\t%s，类型：%s&#x27;%(now_str,type(now_str)))</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">字符串转为datetime</span></span><br><span class="line">str2datetime = datetime.datetime.strptime(now_str,&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">now_time_1 = datetime.datetime.strptime(str(now)[0:19],&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">print(&#x27;字符串转为datetime：\t%s，类型：%s&#x27;%(str2datetime,type(str2datetime)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">将datetime转为时间戳</span></span><br><span class="line">datetime2mktime = time.mktime(today.timetuple())</span><br><span class="line">print(&#x27;\ndatetime转为时间戳：\t%s，类型：%s&#x27;%(datetime2mktime,type(datetime2mktime)))</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">将时间戳转为datetime</span></span><br><span class="line">mktime2datetime = datetime.datetime.fromtimestamp(now_mktime)</span><br><span class="line">print(&#x27;时间戳转为字符串：\t%s，类型：%s&#x27;%(mktime2datetime,type(mktime2datetime)))</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">字符串转为时间戳</span></span><br><span class="line">str2mktime = time.mktime(time.strptime(str(today), &#x27;%Y-%m-%d&#x27;))</span><br><span class="line">print(&#x27;\n字符串转为时间戳：\t%s，类型：%s&#x27;%(str2mktime,type(str2mktime)))</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">时间戳转为字符串</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> time.localtime()将时间戳转换为struct_time</span></span><br><span class="line">mktime2str = time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime(now_mktime))</span><br><span class="line">print(&#x27;时间戳转为字符串：\t%s，类型：%s&#x27;%(mktime2str,type(mktime2str)))</span><br></pre></td></tr></table></figure>

<h2 id="es查询数据"><a href="#es查询数据" class="headerlink" title="es查询数据"></a>es查询数据</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ESGetData</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取es索引数据&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,hosts</span>):</span></span><br><span class="line">        self.hosts = hosts</span><br><span class="line">        self.es_client = zElasticsearch(self.hosts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_data_by_index</span>(<span class="params">self,index:<span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="built_in">print</span>(index)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;通过索引名获取数据&quot;&quot;&quot;</span></span><br><span class="line">        body = &#123;<span class="string">&quot;query&quot;</span>:&#123;<span class="string">&quot;match_all&quot;</span>:&#123;&#125;&#125;&#125;</span><br><span class="line">        general_data = helpers.scan(client=self.es_client,query=body,scroll=<span class="string">&quot;100m&quot;</span>,index=index)</span><br><span class="line">        kind = self.get_index_kind(index)</span><br><span class="line">        <span class="keyword">return</span> general_data,kind</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_data_by_id</span>(<span class="params">self,index,<span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;通过_id 获取数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(index)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = self.es_client.get(index=index, <span class="built_in">id</span>=<span class="built_in">id</span>)</span><br><span class="line">            bin_data = dec_obj_from_str(data[<span class="string">&#x27;_source&#x27;</span>][<span class="string">&#x27;BIN_DATA&#x27;</span>])</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;index &#123;&#125; not has id&quot;</span>.<span class="built_in">format</span>(index, <span class="built_in">id</span>))</span><br><span class="line">            bin_data = &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> bin_data</span><br></pre></td></tr></table></figure>

<h2 id="参数传递使用"><a href="#参数传递使用" class="headerlink" title="参数传递使用"></a>参数传递使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parser_arg</span>(<span class="params">namespace=<span class="literal">None</span></span>):</span></span><br><span class="line">    _parse = argparse.ArgumentParser(description=<span class="string">&quot;check index data&quot;</span>)</span><br><span class="line">    _parse.add_argument(<span class="string">&#x27;-e&#x27;</span>, <span class="string">&#x27;--hosts&#x27;</span>,  <span class="built_in">help</span>=<span class="string">&#x27;es hosts list&#x27;</span>,default=[<span class="string">&quot;192.168.81.192&quot;</span>],nargs=<span class="string">&quot;+&quot;</span>)</span><br><span class="line">    _parse.add_argument(<span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;--index_list&#x27;</span>,  <span class="built_in">help</span>=<span class="string">&#x27;es index list&#x27;</span>,nargs=<span class="string">&quot;+&quot;</span>,default=[<span class="string">&quot;180_binary_e_mp_day_read-13404&quot;</span>,<span class="string">&quot;180_binary_e_mp_cur_curve-13404&quot;</span>,<span class="string">&quot;180_binary_e_mp_power_curve-13404&quot;</span>,<span class="string">&quot;180_binary_e_mp_vol_curve-13404&quot;</span>])</span><br><span class="line">    _parse.add_argument(<span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;--doc_id&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;search _id data&#x27;</span>,default=<span class="literal">None</span>)</span><br><span class="line">    _parse.add_argument(<span class="string">&#x27;-m&#x27;</span>, <span class="string">&#x27;--meter_message&#x27;</span>,nargs=<span class="string">&quot;+&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;search meter message&#x27;</span>,default=<span class="literal">None</span>)</span><br><span class="line">    _parse.add_argument(<span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;--flag&#x27;</span>, nargs=<span class="string">&quot;+&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;search flag&#x27;</span>, default=<span class="literal">None</span>)</span><br><span class="line">    _parse.add_argument(<span class="string">&#x27;-s&#x27;</span>, <span class="string">&#x27;--save_path&#x27;</span>,  <span class="built_in">help</span>=<span class="string">&#x27;save result path&#x27;</span>, default=<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> _parse.parse_args(namespace=namespace)</span><br><span class="line"></span><br><span class="line">args = parser_arg()</span><br><span class="line">index_list = args.index_list</span><br><span class="line">hosts = args.hosts</span><br></pre></td></tr></table></figure>

<h2 id="py-spy-使用"><a href="#py-spy-使用" class="headerlink" title="py-spy 使用"></a>py-spy 使用</h2><p>../.nox/zs_power-opt-py-ve1-bin-python/bin/py-spy <br>record -o /home/zshield/logs/profile.svg – <br>../.nox/zs_power-opt-py-ve1-bin-python/bin/python3.8 -m main.pp2_main <br>-e 192.168.82.86:19200,192.168.80.230:19200 <br>-B –sz_open <br>–sz=/home/zshield/conf/sz_app/sz.conf <br>–process_num ‘{“data”:1,”sz”:1,”comp”:1,”write”:1,”dg”:1,”fs”:1}’ <br>–use-pro-data-mode –high_open</p>
<p>/home/zdzhou/miniconda3/bin/py-spy record -o /home/zdzhou/profile.svg – /home/zdzhou/miniconda3/bin/python -m main.pp2_main -e zxtech:<a href="mailto:&#x5a;&#x78;&#x6f;&#100;&#49;&#49;&#50;&#95;&#x73;&#x68;&#105;&#110;&#105;&#x6e;&#x67;&#49;&#48;&#x40;&#x31;&#x39;&#x32;&#x2e;&#x31;&#54;&#x38;&#x2e;&#x38;&#51;&#x2e;&#52;&#x32;">&#x5a;&#x78;&#x6f;&#100;&#49;&#49;&#50;&#95;&#x73;&#x68;&#105;&#110;&#105;&#x6e;&#x67;&#49;&#48;&#x40;&#x31;&#x39;&#x32;&#x2e;&#x31;&#54;&#x38;&#x2e;&#x38;&#51;&#x2e;&#52;&#x32;</a>:19400 -a 219762232 –on5 13403 –sz_open –comp_topo m<br>onitor_p0_topo_v3.yml -p0 –high_open –day_v2 –use-pro-data-mode –v3_test</p>
<h2 id="python-rocksdb的基本使用"><a href="#python-rocksdb的基本使用" class="headerlink" title="python-rocksdb的基本使用"></a>python-rocksdb的基本使用</h2><p>1.打开数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rocksdb</span><br><span class="line">db = rocksdb.DB(<span class="string">&quot;test.db&quot;</span>,rocksdb.Options(create_if_missing=<span class="literal">True</span>))</span><br><span class="line"><span class="comment"># create_if_missing=True 如果不存在则创建名为&#x27;test.db&#x27;的数据库</span></span><br></pre></td></tr></table></figure>

<p>2.设置键值对和获取值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RocksDB中存储的是byte strings。在python2中为str类型，在python3中为bytes类型。</span></span><br><span class="line">db.put(<span class="string">b&quot;key&quot;</span>,<span class="string">b&quot;value&quot;</span>) <span class="comment">#设置一个键值对，key =&gt; value</span></span><br><span class="line"></span><br><span class="line">db.get(<span class="string">b&quot;key&quot;</span>)          <span class="comment">#获取键为key的值，如果不在则返回为空</span></span><br><span class="line"><span class="string">b&#x27;value&#x27;</span></span><br><span class="line"></span><br><span class="line">db.delete(<span class="string">b&quot;key&quot;</span>)       <span class="comment">#删除键为key为的键值对</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将几个操作合并为一个操作</span></span><br><span class="line">batch = rocksdb.WriteBatch()</span><br><span class="line">batch.put(<span class="string">b&quot;key&quot;</span>, <span class="string">b&quot;v1&quot;</span>)</span><br><span class="line">batch.delete(<span class="string">b&quot;key&quot;</span>)</span><br><span class="line">batch.put(<span class="string">b&quot;key&quot;</span>, <span class="string">b&quot;v2&quot;</span>)</span><br><span class="line">batch.put(<span class="string">b&quot;key&quot;</span>, <span class="string">b&quot;v3&quot;</span>)</span><br><span class="line"></span><br><span class="line">db.write(batch)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次获取多个键值对</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.put(<span class="string">b&quot;key1&quot;</span>,<span class="string">b&quot;v1&quot;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ret = db.multi_get([<span class="string">b&quot;key&quot;</span>,<span class="string">b&quot;key1&quot;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ret</span><br><span class="line">&#123;<span class="string">b&#x27;key&#x27;</span>: <span class="string">b&#x27;v3&#x27;</span>, <span class="string">b&#x27;key1&#x27;</span>: <span class="string">b&#x27;v1&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>3.迭代</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>it = db.iterkeys()  <span class="comment"># 默认是无效的，先得调用seek方法</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it.seek_to_first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">list</span>(it))</span><br><span class="line">[<span class="string">b&#x27;a&#x27;</span>, <span class="string">b&#x27;key&#x27;</span>, <span class="string">b&#x27;key1&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it.seek_to_last()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">list</span>(it))</span><br><span class="line">[<span class="string">b&#x27;key1&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it = db.itervalues()   <span class="comment">#对值进行迭代</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it.seek_to_first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">list</span>(it))</span><br><span class="line">[<span class="string">b&#x27;b&#x27;</span>, <span class="string">b&#x27;v3&#x27;</span>, <span class="string">b&#x27;v1&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it = db.iteritems()   <span class="comment">#对键值对进行迭代</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it.seek_to_first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">list</span>(it))</span><br><span class="line">[(<span class="string">b&#x27;a&#x27;</span>, <span class="string">b&#x27;b&#x27;</span>), (<span class="string">b&#x27;key&#x27;</span>, <span class="string">b&#x27;v3&#x27;</span>), (<span class="string">b&#x27;key1&#x27;</span>, <span class="string">b&#x27;v1&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向迭代</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it.seek_to_last()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">list</span>(<span class="built_in">reversed</span>(it)))</span><br><span class="line">[(<span class="string">b&#x27;key1&#x27;</span>, <span class="string">b&#x27;v1&#x27;</span>), (<span class="string">b&#x27;key&#x27;</span>, <span class="string">b&#x27;v3&#x27;</span>), (<span class="string">b&#x27;a&#x27;</span>, <span class="string">b&#x27;b&#x27;</span>)]</span><br></pre></td></tr></table></figure>

<p>4.快照</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>snapshot = db.snapshot()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it = db.iteritems(snapshot=snapshot)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it</span><br><span class="line">&lt;rocksdb._rocksdb.ItemsIterator <span class="built_in">object</span> at <span class="number">0x7f77ae179608</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it.seek_to_first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">dict</span>(it))</span><br><span class="line">&#123;<span class="string">b&#x27;a&#x27;</span>: <span class="string">b&#x27;b&#x27;</span>, <span class="string">b&#x27;key&#x27;</span>: <span class="string">b&#x27;v3&#x27;</span>, <span class="string">b&#x27;key1&#x27;</span>: <span class="string">b&#x27;v1&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>5.备份和恢复</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份</span></span><br><span class="line">backup = rocksdb.BackupEngine(<span class="string">&quot;test.db/backups&quot;</span>)</span><br><span class="line">backup.create_backup(db, flush_before_backup=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复</span></span><br><span class="line">backup = rocksdb.BackupEngine(<span class="string">&quot;test.db/backups&quot;</span>)</span><br><span class="line">backup.restore_latest_backup(<span class="string">&quot;test.db&quot;</span>, <span class="string">&quot;test.db&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Python处理非标准-json-格式字符串"><a href="#Python处理非标准-json-格式字符串" class="headerlink" title="Python处理非标准 json 格式字符串"></a>Python处理非标准 json 格式字符串</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span> = <span class="built_in">eval</span>(expr, <span class="built_in">type</span>(<span class="string">&#x27;Dummy&#x27;</span>, (<span class="built_in">dict</span>,), <span class="built_in">dict</span>(__getitem__=<span class="keyword">lambda</span> s, n: n))())</span><br></pre></td></tr></table></figure>

<h2 id="python反射"><a href="#python反射" class="headerlink" title="python反射"></a>python反射</h2><h3 id="简单反射"><a href="#简单反射" class="headerlink" title="简单反射"></a>简单反射</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CURVE_DATA_CLASS_MAP = &#123;subclass.<span class="built_in">type</span>: subclass <span class="keyword">for</span> subclass <span class="keyword">in</span> IncrementCurveData.__subclasses__()&#125;</span><br></pre></td></tr></table></figure>

<h3 id="包的反射-类加载"><a href="#包的反射-类加载" class="headerlink" title="包的反射 类加载"></a>包的反射 类加载</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;类加载模块&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> pkgutil</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> alies_to_k8s <span class="keyword">import</span> out_result</span><br><span class="line"><span class="keyword">from</span> alies_to_k8s <span class="keyword">import</span> source</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_similar_class</span>(<span class="params">pkg, cls</span>):</span></span><br><span class="line">    collect = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(pkg, <span class="string">&#x27;__path__&#x27;</span>):</span><br><span class="line">        <span class="keyword">for</span> loader, module_name, is_pkg <span class="keyword">in</span> pkgutil.walk_packages(pkg.__path__, pkg.__name__ + <span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">            <span class="comment"># print(module_name)</span></span><br><span class="line">            <span class="keyword">if</span> module_name <span class="keyword">not</span> <span class="keyword">in</span> sys.modules:</span><br><span class="line">                importlib.import_module(module_name)</span><br><span class="line">            md = sys.modules[module_name]</span><br><span class="line">            md_collect = load_module(md, cls)</span><br><span class="line">            collect.update(md_collect)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        md_collect = load_module(pkg, cls)</span><br><span class="line">        collect.update(md_collect)</span><br><span class="line">    <span class="keyword">return</span> collect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_module</span>(<span class="params">md, cls</span>):</span></span><br><span class="line">    collect = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">vars</span>(md).values():</span><br><span class="line">        <span class="keyword">if</span> inspect.isclass(i) <span class="keyword">and</span> <span class="built_in">issubclass</span>(i, cls):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">getattr</span>(i, <span class="string">&#x27;inuse&#x27;</span>, <span class="string">&#x27;True&#x27;</span>):</span><br><span class="line">                collect[i.name] = i</span><br><span class="line">    <span class="keyword">return</span> collect</span><br><span class="line"></span><br><span class="line">CLIENT = &#123;subclass.name: subclass <span class="keyword">for</span> subclass <span class="keyword">in</span> out_result.IClient.__subclasses__()&#125;</span><br><span class="line">OUT_HANDLER = load_similar_class(out_result, out_result.IOutput)</span><br><span class="line">API_SOURCE = load_similar_class(source,source.ISource)</span><br></pre></td></tr></table></figure>

<h2 id="python使用概念"><a href="#python使用概念" class="headerlink" title="python使用概念"></a>python使用概念</h2><h3 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h3><ol>
<li>在 python 的世界上，所有的数据,包括函数/类全都是对象。在函数传递参数时,只是让两个变量标识相同的对象</li>
<li>如果传递的是不可变对象（int float string tuple）时，对于不可变对象的操作，均会产生新的标识对象，并不影响外部实参对象值</li>
<li>如果传递的是可变对象（dict set list）时，对于可变对象的操作，是在原对象的基础上进行的操作，会改变外部实参对象值</li>
<li>但如果3中对可变对象的操作是重新赋予新的标识，那就会产生新的对象，也就不会影响外部对象，例如x = x+[1]</li>
<li>这里可以类比c++中存在3中传参方式（值传递，引用传递，指针传递），其中值传递，会创建新的对象（形参是实参的拷贝），不会影响外部对象，而引用及指针传递，因为操作的对象和外部对象一致，所以会影响外部对象的值</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2022/05/13/6-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/13/6-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/" class="post-title-link" itemprop="url">6.性能监控</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-13 17:43:42" itemprop="dateCreated datePublished" datetime="2022-05-13T17:43:42+08:00">2022-05-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-04 10:33:07" itemprop="dateModified" datetime="2023-02-04T10:33:07+08:00">2023-02-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="监控方式"><a href="#监控方式" class="headerlink" title="监控方式"></a>监控方式</h2><p>Diamond（Telegraf InfluxDB官方的數據採集） + InfluxDB + Grafana</p>
<h3 id="运行InfluxDB及Grafana"><a href="#运行InfluxDB及Grafana" class="headerlink" title="运行InfluxDB及Grafana"></a>运行InfluxDB及Grafana</h3><p>以下說明以docker運行InfluxDB及Grafana的程序，首先在系統上建立需要的directories:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /BGdata/&#123;influxdb,grafana&#125; /var/log/grafana</span><br></pre></td></tr></table></figure>

<p>在power.git中已有現成的docker-compose YML文件:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">influxdb:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">influxdb:1.8.3</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">influxdb</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">INFLUXDB_HTTP_LOG_ENABLED=false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">INFLUXDB_DATA_QUERY_LOG_ENABLED=false</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/BGdata/influxdb:/var/lib/influxdb</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">grafana:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/grafana:7.3.1</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/BGdata/grafana:/var/lib/grafana</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/var/log/grafana:/var/log/grafana</span></span><br></pre></td></tr></table></figure>

<p>上面定義了兩個docker containers，influxdb及grafana，並且設置需要的volume mapping等等。</p>
<p>接下來使用docker-compose開啟這兩個containers:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@sj-node2 monitor]# /opt/py3.6/ve1/bin/docker-compose -f mon.yml up -d</span><br><span class="line">Creating influxdb ... done</span><br><span class="line">Creating grafana  ... done</span><br><span class="line">[root@sj-node2 monitor]# /opt/py3.6/ve1/bin/docker-compose -f mon.yml ps</span><br><span class="line">  Name            Command           State   Ports</span><br><span class="line">-------------------------------------------------</span><br><span class="line">grafana    /run.sh                  Up</span><br><span class="line">influxdb   /entrypoint.sh influxd   Up</span><br></pre></td></tr></table></figure>

<p>開始使用之前還需要在InfluxDB中建立一個database用來儲存採集的數據，這個可以直接在運行中的influxdb container中使用”influx”工具完成:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@sj-node2 monitor]# docker exec -it influxdb /bin/bash</span><br><span class="line">root@sj-node2:/#</span><br><span class="line">root@sj-node2:/# influx</span><br><span class="line">Connected to http://localhost:8086 version 1.8.3</span><br><span class="line">InfluxDB shell version: 1.8.3</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> show databases</span></span><br><span class="line">name: databases</span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">_internal</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> create database grafana</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> show databases</span></span><br><span class="line">name: databases</span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">_internal</span><br><span class="line">grafana</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上步驟在InfluxDB中建立一個”grafana” database，完成後，就可以開始將監控採集數據寫入這個database中</p>
<h3 id="Diamond-build-install"><a href="#Diamond-build-install" class="headerlink" title="Diamond build/install"></a>Diamond build/install</h3><p>目前已經在公司內部bitbucket建立了一個Diamond的git repo:</p>
<p>ssh://git@192.168.1.139:7999/analytics/diamond.git</p>
<p>Production版本位於”4.0”分支上，是基於4.0.515版本(最近的一個release)，再加上了兩個小改動:</p>
<ul>
<li>支持與較新版本InfluxDB的相容性</li>
<li>支持配置InfluxDB server的base URL</li>
</ul>
<p>除了上面這兩個改動，另外也從master分支合併了關於Elasticsearch collector的幾個小改動，包括支持配置指定username/password (ES開啟authentication的場景)</p>
<p>注意Diamond用的是CentOS 7上default的Python 2.7，因此build環境中需要:</p>
<ul>
<li>Python 2.7: CentOS 7已經default安裝</li>
<li>pip: 可用”yum install python2-pip”安裝</li>
<li>Python的”setuptools”模塊: 可用”pip install setuptools”安裝</li>
<li>Python的”wheel”模塊: 可用”pip install wheel”安裝</li>
</ul>
<p>在準備好的build環境中，如下build出一個wheel包:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ahuang@sj-node1 tmp]$ git clone ssh://git@192.168.1.139:7999/analytics/diamond.git</span><br><span class="line">...</span><br><span class="line">[ahuang@sj-node1 tmp]$ cd diamond/</span><br><span class="line">[ahuang@sj-node1 diamond]$ git checkout 4.0</span><br><span class="line">Branch 4.0 set up to track remote branch 4.0 from origin.</span><br><span class="line">Switched to a new branch &#x27;4.0&#x27;</span><br><span class="line">[ahuang@sj-node1 diamond]$ make bdist_wheel</span><br><span class="line">...</span><br><span class="line">[ahuang@sj-node1 diamond]$ ls -l dist/</span><br><span class="line">total 316</span><br><span class="line">-rw-rw-r--. 1 ahuang ahuang 322632 Nov 13  2020 diamond-4.0.531_zs4-py2.py3-none-any.whl</span><br><span class="line">[ahuang@sj-node1 diamond]$</span><br></pre></td></tr></table></figure>

<p>這個wheel包可以直接用pip安裝在目標系統上，另外目標系統上也須要Python的”influxdb”模塊，例如使用以下命令同時安裝:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install influxdb dist/diamond-4.0.531_zs4-py2.py3-none-any.whl</span><br></pre></td></tr></table></figure>

<p>運行Diamond及config</p>
<p>如 上安裝diamond後，運行config的位置為”/etc/diamond/diamond.conf”，可先將diamond config的例子copy一份，再基於此做修改，另外，diamond本身運行的日志位於”/var/log/diamond” directory，第一次運行前需要建立此directory:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/lib/python2.7/site-packages/etc/diamond/diamond.conf.example /etc/diamond/diamond.conf</span><br><span class="line">mkdir /var/log/diamond</span><br></pre></td></tr></table></figure>

<p>使用以下命令運行diamond</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/diamond</span><br></pre></td></tr></table></figure>

<p>如果需要troubleshoot運行問題(例如config格式錯誤)，可以用debug模式:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/diamond -f -l</span><br></pre></td></tr></table></figure>

<p>Diamond支持非常多的輸入數據源(collectors)及輸出目的地(handlers)，上面的config example中有一些基本的選項，詳細文件可參考:<br><a target="_blank" rel="noopener" href="https://diamond.readthedocs.io/en/latest/">https://diamond.readthedocs.io/en/latest/</a></p>
<p>以下以SJ office用於ES節點監控的例子，說明一些需要的config選項</p>
<p>輸出(handlers)選項<br>這裡要使用的輸出目的地是InfluxDB，因此首先需要在diamond.conf中設定handlers (位於”[server]”下):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[server]</span><br><span class="line">...</span><br><span class="line">handlers = diamond.handler.influxdbHandler.InfluxdbHandler</span><br></pre></td></tr></table></figure>

<p>InfluxdbHandler本身也需要一些選項，因此在”[handlers]”下加上以下這段:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[handlers]</span><br><span class="line">...</span><br><span class="line">[[InfluxdbHandler]]</span><br><span class="line">hostname = 192.168.200.19</span><br><span class="line">batch_size = 100</span><br><span class="line">database = grafana</span><br><span class="line">username = grafana</span><br><span class="line">password = grafana</span><br><span class="line">base_url = /example/proxy/path</span><br></pre></td></tr></table></figure>

<p>這裡的hostname是InfluxDB的位置，database、username、password根據在InfluxDB server上建立的database來設定，base_url則是InfluxDB server的base URL，可供proxy使用(如果不設定則default是””，也就是沒有)，例如，上面在InfluxDB中建立一個名為”grafana”的database，username、password、base_url都不用設定</p>
<p>輸入(collectors)選項<br>Diamond中的各種collectors支持監控不同的metrics，所有collectors共用的選項中有兩個較重要:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[collectors]</span><br><span class="line">[[default]]</span><br><span class="line">hostname = ...</span><br><span class="line">interval = ...</span><br></pre></td></tr></table></figure>

<p>以下說明:</p>
<ul>
<li>hostname: 指定用來標記採集到數據的名字，如果不設定，自動使用系統OS設定的hostname (一般不需要設定)<br>interval: 多久採集一次數據，default是300秒，可視需要調整。(除了這個共用的選項，每個collector也可以指定該collector本身的interval)</li>
<li>這裡的config例子中已經開啟了幾個基本的collectors (例如CPU、memory、disk等等)，我們再加上一個採集Elasticsearch狀況的collector:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[collectors]</span><br><span class="line">...</span><br><span class="line">[[ElasticSearchCollector]]</span><br><span class="line">enabled = True</span><br></pre></td></tr></table></figure>

<p>除了主要的diamond.conf之外，每個collector也可以有自己的config file，例如這裡我們再給兩個collectors加上config files指定一些針對個別collector的選項:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/etc/diamond/collectors/ElasticSearchCollector.conf</span><br><span class="line">enabled = True</span><br><span class="line">interval = 120</span><br><span class="line">cluster = True</span><br><span class="line"></span><br><span class="line">/etc/diamond/collectors/DiskUsageCollector.conf</span><br><span class="line">enabled = True</span><br><span class="line">interval = 120</span><br></pre></td></tr></table></figure>

<p>數據寫入InfluxDB<br>以上面描述的方式配置、運行Diamond後，假設配置正確，Diamond會開始將監控數據寫入InfluxDB中的database，這裡以上面建立的”grafana” database為例，我們可以在InfluxDB的docker container中，使用”influx”工具來確認數據是否寫入:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@sj-node2 ~]# docker exec -it influxdb /bin/bash</span><br><span class="line">root@sj-node2:/#</span><br><span class="line">root@sj-node2:/# influx</span><br><span class="line">Connected to http://localhost:8086 version 1.8.3</span><br><span class="line">InfluxDB shell version: 1.8.3</span><br><span class="line"><span class="meta">&gt;</span></span><br><span class="line"><span class="bash">&gt; show databases</span></span><br><span class="line">name: databases</span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">_internal</span><br><span class="line">grafana</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> use grafana</span></span><br><span class="line">Using database grafana</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面使用influx工具連接上InfluxDB並選擇”grafana”這個database</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> show measurements</span></span><br><span class="line">...</span><br><span class="line">servers.sj-node2.memory.MemAvailable</span><br><span class="line">servers.sj-node2.memory.MemFree</span><br><span class="line">servers.sj-node2.memory.MemTotal</span><br><span class="line">servers.sj-node2.memory.Shmem</span><br><span class="line">servers.sj-node2.memory.SwapCached</span><br><span class="line">servers.sj-node2.memory.SwapFree</span><br><span class="line">servers.sj-node2.memory.SwapTotal</span><br><span class="line">servers.sj-node2.memory.VmallocChunk</span><br><span class="line">servers.sj-node2.memory.VmallocTotal</span><br><span class="line">servers.sj-node2.memory.VmallocUsed</span><br><span class="line">servers.sj-node2.vmstat.pgfault</span><br><span class="line">servers.sj-node2.vmstat.pgmajfault</span><br><span class="line">servers.sj-node2.vmstat.pgpgin</span><br><span class="line">servers.sj-node2.vmstat.pgpgout</span><br><span class="line">servers.sj-node2.vmstat.pswpin</span><br><span class="line">servers.sj-node2.vmstat.pswpout</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>

<p>這裡”show measurements”命令顯示了此database中包括的監控metrics，因為包括ES中所有indices的metrics，數量很多，這裡只顯示少數為例。</p>
<p>在InfluxDB中，每個measurement類似於一個傳統database中的table，InfluxDB提供一個類似於傳統SQL的”InfluxQL”語言，可用於對InfluxDB databases做查詢等等，例如:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> select * from <span class="string">&quot;servers.sj-node2.memory.MemAvailable&quot;</span></span></span><br><span class="line">name: servers.sj-node2.memory.MemAvailable</span><br><span class="line">time                value</span><br><span class="line">----                -----</span><br><span class="line">...</span><br><span class="line">1605652120000000000 33875619840</span><br><span class="line">1605652150000000000 33873670144</span><br><span class="line">1605652180000000000 33927344128</span><br><span class="line">1605652210000000000 33900642304</span><br><span class="line">1605652240000000000 33892270080</span><br><span class="line">1605652270000000000 33880412160</span><br><span class="line">1605652300000000000 33892970496</span><br><span class="line">1605652330000000000 33865535488</span><br><span class="line">1605652360000000000 33865523200</span><br><span class="line">1605652390000000000 33871003648</span><br><span class="line">1605652420000000000 33889140736</span><br><span class="line">1605652450000000000 33888215040</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>

<p>這裡的”select …”命令顯示此measurement中目前為止已經寫入的數據，每筆數據包括一個timestamp及value</p>
<p>關於”influx”工具、InfluxQL語言等等的詳細文件可參見: <a target="_blank" rel="noopener" href="https://docs.influxdata.com/influxdb/v1.8/">https://docs.influxdata.com/influxdb/v1.8/</a></p>
<p>使用Grafana<br>上面使用docker-compose已經開啟了Grafana，使用browser連接URL “https://<IP>:3000”，首先使用以下步驟添加data source:</p>
<ul>
<li><p>使用default的username/password “admin”/“admin”登入</p>
</li>
<li><p>選擇左側的”Configuration”-&gt;”Data Sources”</p>
</li>
<li><p>選擇”Add data source”</p>
</li>
<li><p>Data source type選擇InfluxDB</p>
</li>
<li><p>細節配置的部分，如果根據以上的測試程序，這裡大部分可以不填，只需改動以下配置:</p>
<ul>
<li>“HTTP”-&gt;”URL”: “http://<IP>:8086”</li>
<li>“InfluxDB Details”-&gt;”Database”: “grafana”</li>
</ul>
</li>
<li><p>選擇”Save &amp; Test”，Grafana根據配置測試後顯示”Data source is working”，並且儲存data source的配置</p>
</li>
<li><p>再選擇左側的”Configuration”-&gt;”Data Sources”，可看到上面配置的data source，名為”InfluxDB”(這個是default name，如果需要可以在上面配置時改名)<br>配置好data source後，就可以將監控數據做可視化，在power.git中已經有一個Grafana dashboard的基本例子”src/monitor/grafana-dash-diamond.json”，可以使用以下步驟import這個例子:</p>
</li>
<li><p>選擇左側的”Dashboards”→”Manage”</p>
</li>
<li><p>選擇”Import”</p>
</li>
<li><p>選擇”Upload JSON file”</p>
</li>
<li><p>選擇上面提到的”grafana-dash-diamond.json”</p>
</li>
<li><p>Options可以保留defaults不需改動，選擇”Import”<br>完成import後即可看到dashboard顯示目前有的監控數據:</p>
</li>
</ul>
<p>注意這裡上方的”src”選項顯示的是之前建立的data source，而”node”選項則會自動列出data source中所有存在的hosts</p>
<h3 id="influxdb的快照和还原"><a href="#influxdb的快照和还原" class="headerlink" title="influxdb的快照和还原"></a>influxdb的快照和还原</h3><h4 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h4><p>在influxdb容器所在的节点上进行以下操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it influxdb bash</span><br><span class="line">influxd backup -portable -database grafana -start 2022-01-17T02:00:00Z -end 2022-01-18T13:00:00Z /tmp/data/grafana （此命令中的时间为UTC时间，需要在实际时间上减8小时）</span><br><span class="line">cd /tmp</span><br><span class="line">tar cvf ./data.tar ./data/*</span><br><span class="line">rm -rf data/</span><br><span class="line">exit</span><br><span class="line">docker cp influxdb:/tmp/data.tar /home/zshield/data.tar</span><br></pre></td></tr></table></figure>

<h4 id="还原"><a href="#还原" class="headerlink" title="还原"></a>还原</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker cp data.tar influxdb:/</span><br><span class="line">docker exec -it influxdb /bin/bash</span><br><span class="line">tar -xvf data.tar</span><br><span class="line">influxd restore -portable -db grafana  -newdb  anhui_527 /data/grafana    (这样就将原来库grafana还原成 anhui_527)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sk-xinye.github.io/2022/02/18/2-%E7%8E%AF%E5%A2%83%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sk-xinye">
      <meta itemprop="description" content="愿所有努力都不被辜负">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sk-xinyeの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/18/2-%E7%8E%AF%E5%A2%83%E5%8C%85/" class="post-title-link" itemprop="url">2.环境包</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-18 10:26:03" itemprop="dateCreated datePublished" datetime="2022-02-18T10:26:03+08:00">2022-02-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-04 10:33:07" itemprop="dateModified" datetime="2023-02-04T10:33:07+08:00">2023-02-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="列出whl包依赖"><a href="#列出whl包依赖" class="headerlink" title="列出whl包依赖"></a>列出whl包依赖</h2><p>/opt/py/ve1/bin/pkginfo -f requires_dist redis-4.1.3-py3-none-any.whl</p>
<p>pip freeze &gt;requirements.txt</p>
<p>pip download -r requirements.txt</p>
<p>pip install –no-index –find-links=”.” -r requirements.txt</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/default-index/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/default-index/">1</a><span class="page-number current">2</span><a class="page-number" href="/default-index/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/default-index/page/15/">15</a><a class="extend next" rel="next" href="/default-index/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">sk-xinye</p>
  <div class="site-description" itemprop="description">愿所有努力都不被辜负</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">142</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sk-xinye</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
